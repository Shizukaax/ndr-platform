#!/usr/bin/env python3
"""
NDR Platform - Basic Usage Example
This example shows how to load data and run anomaly detection.
"""

import sys
import json
from pathlib import Path

# Add project root to path
sys.path.append(str(Path(__file__).parent.parent))

from core.data_manager import DataManager
from core.model_manager import ModelManager

def basic_anomaly_detection():
    """Basic anomaly detection example."""
    print("üîç NDR Platform - Basic Example")
    print("=" * 40)
    
    # Initialize components
    data_manager = DataManager()
    model_manager = ModelManager()
    
    # Load sample data
    print("\nüìÇ Loading sample data...")
    data_file = Path("data/examples/sample_network_data.json")
    
    if not data_file.exists():
        print("‚ùå Sample data not found. Run 'python scripts/setup.py' first.")
        return
    
    # Load and process data
    data = data_manager.load_json_data(str(data_file))
    print(f"‚úÖ Loaded {len(data)} network records")
    
    # Convert to DataFrame for processing
    df = data_manager.json_to_dataframe(data)
    print(f"üìä DataFrame shape: {df.shape}")
    
    # Run anomaly detection
    print("\nü§ñ Running anomaly detection...")
    
    # Use Isolation Forest (default model)
    model = model_manager.get_model('IsolationForest')
    
    # Prepare features (simple example)
    numeric_features = ['src_port', 'dst_port', 'bytes', 'packets']
    features = df[numeric_features].fillna(0)
    
    # Train and predict
    model.fit(features)
    anomaly_scores = model.predict(features)
    
    # Show results
    anomalies = df[anomaly_scores == -1]  # -1 indicates anomaly
    print(f"üö® Found {len(anomalies)} potential anomalies out of {len(df)} records")
    print(f"üìà Anomaly rate: {len(anomalies)/len(df)*100:.2f}%")
    
    # Display first few anomalies
    if len(anomalies) > 0:
        print("\nüîç Sample anomalies:")
        for idx, row in anomalies.head(3).iterrows():
            print(f"   ‚Ä¢ {row['src_ip']}:{row['src_port']} ‚Üí {row['dst_ip']}:{row['dst_port']}")
            print(f"     Protocol: {row['protocol']}, Bytes: {row['bytes']}")
    
    return anomalies

if __name__ == "__main__":
    try:
        anomalies = basic_anomaly_detection()
        print("\n‚úÖ Example completed successfully!")
        print("\nüí° Next steps:")
        print("   ‚Ä¢ Run the full platform: streamlit run run.py")
        print("   ‚Ä¢ Explore more examples in the examples/ folder")
        print("   ‚Ä¢ Check documentation in docs/")
        
    except Exception as e:
        print(f"\n‚ùå Error: {e}")
        print("\nüîß Troubleshooting:")
        print("   ‚Ä¢ Run: python scripts/setup.py")
        print("   ‚Ä¢ Install dependencies: pip install -r requirements.txt")
